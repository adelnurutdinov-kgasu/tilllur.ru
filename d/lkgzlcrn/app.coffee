

screen = new Layer
	width: 360
	height: 720
	backgroundColor: "black"

# Size Classes

sizeClassA = {
	rowSize: 5,
	iconSize: 56,
	iconGap: 12,
	iconFontSize: 14
}

sizeClassB = {
	rowSize: 5,
	iconSize: 48,
	iconGap: 20,
	iconFontSize: 12
}

sizeClassC = {
	rowSize: 4,
	iconSize: 56,
	iconGap: 28,
	iconFontSize: 13
}

sizeClass = sizeClassA

# SVG Apps Map

svgAppIcons = {
	"Алиса": "Appicon_alice.svg",
	"Афиша": "Appicon_afisha.svg",
	"АОН": "Appicon_aon.svg",
	"Метрика": "Appicon_appmetric.svg",
	"Аура": "Appicon_aura.svg",
	"Авиабилеты": "Appicon_avia.svg",
	"Авто.ру": "Appicon_avtoru.svg",
	"Беру": "Appicon_beru.svg",
	"Брингли": "Appicon_bringly.svg",
	"Календарь": "Appicon_calendar.svg",
	"Кэшбэк": "Appicon_cashback.svg",
	"Чаты": "Appicon_chats.svg",
	"Коллекции": "Appicon_collection.svg",
	"t1": "Appicon_default_eng.svg",
	"t2": "Appicon_default_rus.svg",
	"Директ": "Appicon_direct.svg",
	"Диск": "Appicon_disk.svg",
	"Драйв": "Appicon_drive.svg",
	"Еда": "Appicon_eda.svg",
	"Едадил": "Appicon_edadeal.svg",
	"Эфир": "Appicon_efir.svg",
	"Знатоки": "Appicon_faq.svg",
	"Игры": "Appicon_games.svg",
	"Здоровье": "Appicon_health.svg",
	"Устройства": "Appicon_home.svg",
	"Картинки": "Appicon_images.svg",
	"t3": "Appicon_internetometr.svg",
	"Изолента": "Appicon_izolenta.svg",
	"Работа": "Appicon_jobs.svg",
	"Кинопоиск": "Appicon_kinopoisk.svg",
	"Лончер": "Appicon_launcher.svg",
	"Район": "Appicon_local.svg",
	"Почта": "Appicon_mail.svg",
	"Карты": "Appicon_maps.svg",
	"Маркет": "Appicon_market.svg",
	"m1": "Appicon_metro_ekb.svg",
	"Метро": "Appicon_metro_msk.svg",
	"m2": "Appicon_metro_samara.svg",
	"m3": "Appicon_metro_spb.svg",
	"Зеркало": "Appicon_mirror.svg",
	"Деньги": "Appicon_money.svg",
	"Музыка": "Appicon_music.svg",
	"Навигатор": "Appicon_navi.svg",
	"Нежвижимость": "Appicon_nedvijimost.svg",
	"Новости": "Appicon_news.svg",
	"Переводы": "Appicon_perevod.svg",
	"p1": "Appicon_photo-1.svg",
	"Фото": "Appicon_photo.svg",
	"Плюс": "Appicon_plus.svg",
	"Практикум": "Appicon_praktikum.svg",
	"QR": "Appicon_qr.svg",
	"Расписание": "Appicon_raspisania.svg",
	"Настройки": "Appicon_settings.svg",
	"Шеф": "Appicon_sheff.svg",
	"Спорт": "Appicon_sport.svg",
	"Такси": "Appicon_taxi.svg",
	"Время": "Appicon_time.svg",
	"Толока": "Appicon_toloka.svg",
	"Поезда": "Appicon_trains.svg",
	"Переводчик": "Appicon_translate.svg",
	"Транспорт": "Appicon_transport.svg",
	"Путешествия": "Appicon_travel.svg",
	"t1": "Appicon_tutor.svg",
	"t2": "Appicon_tvonline.svg",
	"t3": "Appicon_ugc.svg",
	"Услуги": "Appicon_uslugi.svg",
	"Видео": "Appicon_video.svg",
	"Погода": "Appicon_weather.svg",
	"Дзен": "Appicon_zen.svg",
	"Знатоки": "Appicon_znatoki.svg",	
}




# SVG Menu Map

svgMenuIcons = {
	"Темная тема": "bro_menu_dark.svg",
	"Закладки": "bookmark (new).svg",
	"Добавить в Избранное": "add to bookmarks (new).svg",
	"Удалить из Избранного": "bro_bookmark_delete.svg",
	"Блокировать рекламу": "bro_custo_menu_block_ads.svg",
	"Блокировка рекламы включена": "bro_custo_menu_block_ads_on.svg",
	"Изменить Закладку": "bro_custo_menu_bookmarks_on.svg",
	"Сообщить об ошибке": "bro_custo_menu_bug.svg",
	"Изменить фон": "bro_custo_menu_change_background.svg",
	"Закрыть все вкладки Инкогнито": "bro_custo_menu_close_all_incognito_tabs.svg",
	"Закрыть все вкладки": "bro_custo_menu_close_all_tabs.svg",
	"Копировать": "bro_custo_menu_copy.svg",
	"Добавить на Табло": "bro_custo_menu_dashboard_add.svg",
	"Удалить из Табло": "bro_custo_menu_dashboard_delete.svg",
	"Табло заполнено": "bro_custo_menu_dashboard_full.svg",
	"Выход": "bro_custo_menu_exit.svg",
	"Дополнения": "bro_custo_menu_extensions.svg",
	"Поиск по странице": "bro_custo_menu_find_in_page.svg",
	"Вперед": "bro_custo_menu_forward.svg",
	"Полная версия сайта": "bro_custo_menu_full_site_off.svg",
	"Полная версия сайта": "bro_custo_menu_full_site_on.svg",
	"Новая вкладка Инкогнито": "bro_custo_menu_new_incognito_tab.svg",
	"Новая вкладка": "bro_custo_menu_newtab.svg",
	"Печать": "bro_custo_menu_print.svg",
	"s1": "bro_custo_menu_share (old).svg",
	"Поделиться": "bro_custo_menu_share.svg",
	"Добавить на экран Домой": "bro_custo_menu_shortcut_add.svg",
	"s2": "bro_custo_menu_tab_background.svg",
	"s3": "bro_custo_menu_video.svg",
	"Назад": "bro_menu_back.svg",
	"12коллекции": "bro_menu_collections_add.svg",
	"12": "bro_menu_dashboard_add.svg",
	"Загрузки": "bro_menu_downloads.svg",
	"Поиск по картинке": "bro_menu_image_search.svg",
	"Пароли": "bro_menu_password_manager.svg",
	"Карты": "bro_menu_cards.svg",
	"Настройки": "bro_menu_settings.svg",
	"Перевести страницу": "bro_menu_translator.svg",
	"Сделать браузером по умолчанию": "bro_set_default_menu_item.svg",
	"Чаты": "chats.svg",
	"История": "history (new).svg",
}


# Create App Icon

getIconTitle = (appViewLayer) ->
	return appViewLayer.children[1]

createIcon = (iconName, isText = false, badgeCount = 0, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	if svgAppIcons[iconName] is undefined then print "Failed: #{iconName}"
	
	appView = new Layer
		width: iconSize
		height: iconSize * 2
		backgroundColor: "transparent"
		name: ".appView"
	
	appIcon = new Layer
		parent: appView
		image: "images/svg/" + svgAppIcons[iconName]
		size: iconSize
		borderRadius: 12
	
	appTitle = new TextLayer
		parent: appView
		width: appIcon.width + (iconGap - 4)
		x: - (iconGap - 4) / 2
		fontSize: iconFontSize
		lineHeight: 1.2
		y: appIcon.height + 8
		textAlign: "center"
		fontWeight: "500"
		text: iconName
		color: "white"
		height: 36
		truncate: true
	
	appTitle.states =
		"shown": { opacity: 0.6 }
		"hidden": { opacity: 0 }
	
	if isText then appTitle.stateSwitch("shown")
	else appTitle.stateSwitch("hidden")
# 	print appTitle.fontSize
	
	
	appBadge = new Layer
		parent: appView
		size: 24
		x: 40
		y: -8
		borderRadius: "100%"
		backgroundColor: "#EB3A38"
	
	appBadge.states =
		"shown": { opacity: 1 }
		"hidden": { opacity: 0 }
	
	if badgeCount != 0 then appBadge.stateSwitch("shown")
	else appBadge.stateSwitch("hidden")
	
	
	
	appBadgeCounter = new TextLayer
		parent: appBadge
		width: appBadge.width
		fontSize: 13
		y: 3
		textAlign: "center"
		fontWeight: "bold"
		text: badgeCount
		color: "white"
		height: 36
		truncate: true
	
	
	return appView




# Create Menu Icon

createMenuIcon = (iconName, isText = true, badgeCount = 0, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	if svgMenuIcons[iconName] is undefined then print "Failed: #{iconName}"
	
	appView = new Layer
		width: iconSize
		height: iconSize * 2
		backgroundColor: "transparent"
	
	appIcon = new Layer
		parent: appView
		backgroundColor: "#F2F2F2"
		size: iconSize
		borderRadius: 12
	
	appMenuIcon = new Layer
		parent: appIcon
		size: 28
		x: Align.center()
		y: Align.center()
		image: "images/svgMenu/" + svgMenuIcons[iconName]
	
	appTitle = new TextLayer
		parent: appView
		width: appIcon.width + (iconGap - 4)
		x: -(iconGap - 4) / 2
		fontSize: iconFontSize
		lineHeight: 1.2
		y: appIcon.height + 8
		textAlign: "center"
		fontWeight: "500"
		text: iconName
		color: "#000"
		height: 36
		truncate: true
	
	appTitle.states =
		"shown": { opacity: 0.6 }
		"hidden": { opacity: 1 }
	
	if isText then appTitle.stateSwitch("shown")
	else appTitle.stateSwitch("hidden")
	
	
	
	appBadge = new Layer
		parent: appView
		size: 24
		x: 40
		y: -8
		borderRadius: "100%"
		backgroundColor: "#EB3A38"
	
	appBadge.states =
		"shown": { opacity: 1 }
		"hidden": { opacity: 0 }
	
	if badgeCount != 0 then appBadge.stateSwitch("shown")
	else appBadge.stateSwitch("hidden")
	
	
	
	appBadgeCounter = new TextLayer
		parent: appBadge
		width: appBadge.width
		fontSize: 13
		y: 3
		textAlign: "center"
		fontWeight: "bold"
		text: badgeCount
		color: "white"
		height: 36
		truncate: true
	
	
	return appView

# Section Header

createSectionHeader = () ->
	


scrollMenu = new ScrollComponent
	parent: scrollBox
	size: scrollBox.size
	backgroundColor: "transparent"
	scrollHorizontal: false
	contentInset:
		top: 12
		bottom: 60


bestAppArray = ["Такси", "Еда", "Район", "Чаты", "Почта", "Эфир", "Коллекции", "Едадил", "Карты", "Переводчик", "Музыка", "Зеркало", "Кинопоиск", "Беру", "Диск", "Устройства", "Дзен", "Афиша", "Метро"]

# App Rows

createGridRows = (nameArray, rSize = 5, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	rowArray = []
	currentRow = null
	
	for currentName, i in nameArray
		if i % rSize == 0
			rowArray.push new Layer
				height: iconSize * 2, width: 328, backgroundColor: "transparent"
		
		lastRowView = rowArray[rowArray.length - 1]
		
		currentIcon = createIcon(currentName, false, 0, iconSize, iconGap, iconFontSize)
		currentIcon.parent = lastRowView
		currentIcon.x = (i % rSize) * (iconSize + iconGap)
	
	return rowArray


# App Grid

makeNewTabGrid = (nameArray, rowSize = 5, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	rows = createGridRows(nameArray, rowSize, iconSize, iconGap, iconFontSize)
	
	gridView = new Layer
		width: 360
		height: 640
		backgroundColor: "transparent"
	
	for row, i in rows
		row.parent = gridView
		row.x = (360 - rowSize * iconSize - (rowSize - 1) * iconGap) / 2
		
		row.states =
			"hidden":
				y: 52 - (iconSize + iconSize / 4) * i
			"shown":
				y: 516 - (iconSize * 2) * i
		row.stateSwitch("hidden")
	
	return gridView

newTabAppsView = makeNewTabGrid(bestAppArray, sizeClass.rowSize, sizeClass.iconSize, sizeClass.iconGap, sizeClass.iconFontSize)
newTabAppsView.parent = screen



menuArray = ["Новая вкладка", "Новая вкладка Инкогнито", "Закладки", "История", "Темная тема", "Пароли", "Карты", "Загрузки", "Дополнения", "Настройки"]

# Menu Rows

createMenuRows = (nameArray, rSize = 5, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	rowArray = []
	currentRow = null
	
	for currentName, i in nameArray
		if i % rSize == 0 then rowArray.push new Layer
			height: iconSize * 2, width: 328, backgroundColor: "transparent"
		
		lastRowView = rowArray[rowArray.length - 1]
		
		currentIcon = createMenuIcon(currentName, true, 0, iconSize, iconGap, iconFontSize)
		currentIcon.parent = lastRowView
		currentIcon.x = (i % rSize) * (iconSize + iconGap)
		
# 		currentIcon.draggable.enabled = true
	
	return rowArray



# Menu Grid

createMenuGrid = (nameArray, rowSize = 5, iconSize = 56, iconGap = 12, iconFontSize = 14) ->
	rows = createMenuRows(nameArray, rowSize, iconSize, iconGap, iconFontSize)
	
	gridView = new Layer
		width: 360
		height: rows.length * iconSize * 2
		backgroundColor: "transparent"
	
	for row, i in rows
		row.parent = gridView
		row.x = (360 - rowSize * iconSize - (rowSize - 1) * iconGap) / 2
		row.y = (56 * 2) * i
		
	return gridView

menuItemsView = createMenuGrid(menuArray, sizeClass.rowSize, sizeClass.iconSize, sizeClass.iconGap, sizeClass.iconFontSize)
menuItemsView.parent = scrollMenu.content

sections = [
	{
		title: "Последнее"
		array: ["Беру", "Почта"]
	},

	{
		title: "Главное"
		array: ["Авто.ру", "Аура", "Дзен", "Игры", "Зеркало", "Коллекции", "Кэшбэк", "Маркет", "Музыка", "Новости", "Директ", "Район", "Эфир", "Спорт"]
	},
	
	{
		title: "Все сервисы"
		array: bestAppArray
	},
	
	{
		title: "Последнее"
		array: ["Беру", "Почта"]
	},
]





# Section Grid

createMenuAppSection = (nameArray, rowSize = 5, iconSize = 56, iconGap = 12, iconFontSize = 14, sectionTitleName) ->
	rows = createGridRows(nameArray, rowSize, iconSize, iconGap, iconFontSize)
	
	gridView = new Layer
		width: 360
		height: rows.length * iconSize * 2 + sectionHeader.height
		backgroundColor: "transparent"
	
	currentSection = sectionHeader.copy()
	currentSection.children[0].text = sectionTitleName
	currentSection.parent = gridView
	currentSection.y = 0
	currentSection.x = 0
	
	for row, i in rows
		row.parent = gridView
		row.x = (360 - rowSize * iconSize - (rowSize - 1) * iconGap) / 2
		row.y = (56 * 2) * i + sectionHeader.height
		
		
		for appIcon in row.children
			appTitle = getIconTitle(appIcon)
			appTitle.states.shown.color = "black"
			appTitle.stateSwitch("shown")
		
	return gridView

sumSectionHeight = 0
for section in sections
	sectionView = createMenuAppSection(section.array, sizeClass.rowSize, sizeClass.iconSize, sizeClass.iconGap, sizeClass.iconFontSize, section.title)
	
	sectionView.parent = scrollMenu.content
	sectionView.y = menuItemsView.height + sumSectionHeight
	sumSectionHeight += sectionView.height


# tempView = createMenuAppSection(bestAppArray, sizeClass.rowSize, sizeClass.iconSize, sizeClass.iconGap, sizeClass.iconFontSize, "Популярные")
# 
# tempView.parent = scrollMenu.content
# tempView.y = menuItemsView.height

# print menuItemsView.height



# Pages

newTabView = new PageComponent
	parent: screen
	width: 360
	height: 640

for currentName, i in ["top", "mid", "bottom"]
	currentPage = new Layer
		size: newTabView.size
		parent: newTabView.content
		y: newTabView.height * i
		backgroundColor: Utils.randomColor()
		opacity: 0

newTabView.snapToPage(newTabView.content.children[1], false)

newTabView.content.on "change:y", ->
	value = newTabView.scrollY
	bounds = [newTabView.height, 0]
	boundsOpacity = [newTabView.height / 2, 0]
	
	for row in newTabAppsView.children
		
		for currentIcon in row.children
			currentTitle = getIconTitle(currentIcon)
			currentTitle.opacity = Utils.modulate(value, boundsOpacity, [currentTitle.states.hidden.opacity, currentTitle.states.shown.opacity])
		
		row.y = Utils.modulate(value, bounds, [row.states.hidden.y, row.states.shown.y])
		
		newTab.y = Utils.modulate(value, bounds, [0, 480])
		
	



# Design Tab Composition


for item in [wallpaper, statusBar, navBar, bottomBar, newTab]
	item.parent = screen

wallpaper.sendToBack()
wallpaper.image = null
wallpaper.opacity = 0


wallpaperFix = new Layer
	parent: screen
	width: 360
	height: 720
	image: "images/temp.png"
	image: "images/temp1.jpg"

wallpaperFix.sendToBack()

bottomBar.bringToFront()
navBar.bringToFront()
statusBar.bringToFront()



appScreen.parent = screen


omniFix = new Layer
	parent: newTab
	width: 328
	height: 48
	x: Align.center
	y: Align.center(-112)
	borderRadius: 12
	backgroundColor: "white"


appScreen.x = 0
appScreen.placeBehind(navBar)
appScreen.states =
	"shown": { y: 40 }
	"hidden": { y: 720 }
appScreen.stateSwitch("hidden")



bottomBar.on Events.Tap, ->
	appScreen.animate("shown", time: .5, curve: Spring(damping: 1))

# navBar.on Events.Tap, ->
# 	appScreen.animate("hidden", time: .5, curve: Spring(damping: 1))


statusBar.opacity = 0


statusBar1 = new Layer
	parent: screen, width: screen.width, height: 32, backgroundColor: "black"

{ Preview } = require "PreviewComponent"
new Preview { view: screen, borderRadius: 16, statusBar: "light" }



backButton = new Layer
	parent: appScreen
	width: 360
	height: 80
	backgroundColor: null

backButton.onTap ->
	appScreen.animate("hidden", time: .5, curve: Spring(damping: 1))